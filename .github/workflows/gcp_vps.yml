name: Deploy to Server

on:
  push:
    branches:
      - main  # Trigger on push to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up SSH agent
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}  # GitHub secret for SSH private key

    - name: Deploy to server
      run: |
        echo "Deploying to server..."
        
        # Create the SSH directory if it doesn't exist
        mkdir -p ~/.ssh
        
        # Add the SSH host to known_hosts to prevent SSH warnings about authenticity
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
        # SSH into the server and perform deployment
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << EOF
          cd /var/www/api.yativo.com || exit
          git pull origin main || exit  # Replace 'main' with your branch if necessary
          chown -R www-data:www-data /var/www/api.yativo.com
          chmod -R 775 /var/www/api.yativo.com/storage /var/www/api.yativo.com/bootstrap/cache
          # Restart PHP-FPM
          systemctl restart php7.4-fpm  # Adjust PHP version if necessary
          # Optionally clear Laravel's cache
          php artisan config:clear
          php artisan cache:clear
          php artisan optimize
        EOF

    - name: Deployment successful
      run: echo "Deployment completed successfully!"
